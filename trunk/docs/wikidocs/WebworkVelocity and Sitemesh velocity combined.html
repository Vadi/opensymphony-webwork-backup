<html>
    <head>
        <title>WebWork - 
        WebworkVelocity and Sitemesh velocity combined
         </title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="code"><div class="codeContent">
<pre class="code-java">/*
 * Copyright (c) 2002-2003 by OpenSymphony
 * All rights reserved.
 */
<span class="code-keyword">package</span> com.diamondip.common.views.velocity;

<span class="code-keyword">import</span> java.io.IOException;
<span class="code-keyword">import</span> java.io.StringWriter;
<span class="code-keyword">import</span> java.io.UnsupportedEncodingException;
<span class="code-keyword">import</span> java.io.Writer;

<span class="code-keyword">import</span> javax.servlet.ServletConfig;
<span class="code-keyword">import</span> javax.servlet.ServletException;
<span class="code-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="code-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="code-keyword">import</span> javax.servlet.jsp.JspFactory;
<span class="code-keyword">import</span> javax.servlet.jsp.PageContext;

<span class="code-keyword">import</span> org.apache.velocity.Template;
<span class="code-keyword">import</span> org.apache.velocity.context.Context;
<span class="code-keyword">import</span> org.apache.velocity.exception.MethodInvocationException;
<span class="code-keyword">import</span> org.apache.velocity.exception.ParseErrorException;
<span class="code-keyword">import</span> org.apache.velocity.exception.ResourceNotFoundException;
<span class="code-keyword">import</span> org.apache.velocity.runtime.RuntimeSingleton;
<span class="code-keyword">import</span> org.apache.velocity.servlet.VelocityServlet;
<span class="code-keyword">import</span> org.apache.velocity.tools.view.context.ChainedContext;
<span class="code-keyword">import</span> org.apache.velocity.tools.view.servlet.VelocityViewServlet;

<span class="code-keyword">import</span> com.opensymphony.module.sitemesh.*;
<span class="code-keyword">import</span> com.opensymphony.module.sitemesh.util.OutputConverter;
<span class="code-keyword">import</span> com.opensymphony.webwork.ServletActionContext;
<span class="code-keyword">import</span> com.opensymphony.webwork.config.Configuration;
<span class="code-keyword">import</span> com.opensymphony.webwork.views.velocity.VelocityManager;
<span class="code-keyword">import</span> com.opensymphony.xwork.ActionContext;


/**
 * @author $Author$
 * @author Matthew Payne
 * @version $Revision$
 */
<span class="code-keyword">public</span> class WebWorkVelocityServlet <span class="code-keyword">extends</span> VelocityViewServlet {
    <span class="code-comment">//~ Instance fields ////////////////////////////////////////////////////////
</span>
    <span class="code-keyword">private</span> VelocityManager velocityManager;

    <span class="code-comment">//~ Constructors ///////////////////////////////////////////////////////////
</span>
    <span class="code-keyword">public</span> WebWorkVelocityServlet() {
        velocityManager = VelocityManager.getInstance();
    }

    <span class="code-comment">//~ Methods ////////////////////////////////////////////////////////////////
</span>
    <span class="code-keyword">public</span> void init(ServletConfig servletConfig) <span class="code-keyword">throws</span> ServletException {
        <span class="code-keyword">super</span>.init(servletConfig);

        <span class="code-comment">// initialize our VelocityManager
</span>        velocityManager.init(servletConfig.getServletContext());
        servletConfig.getServletContext().setAttribute(<span class="code-quote">"webwork.servlet"</span>, <span class="code-keyword">this</span>);
    }

    <span class="code-keyword">protected</span> Context createContext(HttpServletRequest request, HttpServletResponse response) {
                <span class="code-comment">// first get manager's context from www
</span>            Context ctx = velocityManager.createContext(ActionContext.getContext().getValueStack(), request, response); 
            ChainedContext chained = <span class="code-keyword">new</span> ChainedContext(ctx, request, response, getServletContext());

           /* <span class="code-keyword">if</span> we have a toolbox manager, get a toolbox from it */
                <span class="code-keyword">if</span> (toolboxManager != <span class="code-keyword">null</span>)
                {
                                chained.setToolbox(toolboxManager.getToolboxContext(chained));
                }
                <span class="code-keyword">return</span> chained;
    }

    <span class="code-keyword">protected</span> Template handleRequest(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Context context) <span class="code-keyword">throws</span> Exception {
        HttpServletRequest request = httpServletRequest;

        HTMLPage htmlPage = (HTMLPage) request.getAttribute(RequestConstants.PAGE);
        <span class="code-object">String</span> template;

        context.put(<span class="code-quote">"base"</span>, request.getContextPath());
        <span class="code-keyword">if</span> (htmlPage == <span class="code-keyword">null</span>) {
            context.put(<span class="code-quote">"title"</span>, <span class="code-quote">"Title?"</span>);
            context.put(<span class="code-quote">"body"</span>, <span class="code-quote">"&lt;p&gt;Body?&lt;/p&gt;"</span>);
            context.put(<span class="code-quote">"head"</span>, <span class="code-quote">"&lt;!-- head --&gt;"</span>);
                template = (<span class="code-object">String</span>) httpServletRequest.getAttribute(<span class="code-quote">"javax.servlet.include.servlet_path"</span>);

            <span class="code-keyword">if</span> (template == <span class="code-keyword">null</span>) {
                template = httpServletRequest.getServletPath();
            }

        }
        <span class="code-keyword">else</span> {
            context.put(<span class="code-quote">"title"</span>, OutputConverter.convert(htmlPage.getTitle()));
            {
                StringWriter buffer = <span class="code-keyword">new</span> StringWriter();
                htmlPage.writeBody(OutputConverter.getWriter(buffer));
                context.put(<span class="code-quote">"body"</span>, buffer.toString());
            }
            {
                StringWriter buffer = <span class="code-keyword">new</span> StringWriter();
                htmlPage.writeHead(OutputConverter.getWriter(buffer));
                context.put(<span class="code-quote">"head"</span>, buffer.toString());
            }
            context.put(<span class="code-quote">"page"</span>, htmlPage);
            Factory factory = Factory.getInstance(<span class="code-keyword">new</span> Config(getServletConfig()));
            Decorator decorator = factory.getDecoratorMapper().getDecorator(request, htmlPage);
            template = decorator.getPage();
        }

        <span class="code-keyword">return</span> getTemplate(template, getEncoding());
    }

     /**
     * create a PageContext and render the template to PageContext.getOut()
     *
     * @see VelocityServlet#mergeTemplate(Template, Context, HttpServletResponse) <span class="code-keyword">for</span> additional documentation
     */
    <span class="code-keyword">protected</span> void mergeTemplate(Template template, Context context, HttpServletResponse response) <span class="code-keyword">throws</span> ResourceNotFoundException, ParseErrorException, MethodInvocationException, IOException, UnsupportedEncodingException, Exception {
        <span class="code-comment">// save the old PageContext
</span>        PageContext oldPageContext = ServletActionContext.getPageContext();

        <span class="code-comment">// create a <span class="code-keyword">new</span> PageContext
</span>        JspFactory jspFactory = JspFactory.getDefaultFactory();
        HttpServletRequest request = (HttpServletRequest) context.get(VelocityManager.REQUEST);

        PageContext pageContext = jspFactory.getPageContext(<span class="code-keyword">this</span>, request, response, <span class="code-keyword">null</span>, <span class="code-keyword">true</span>, 8192, <span class="code-keyword">true</span>);

        <span class="code-comment">// put the <span class="code-keyword">new</span> PageContext into ActionContext
</span>        ActionContext actionContext = ActionContext.getContext();
        actionContext.put(ServletActionContext.PAGE_CONTEXT, pageContext);

        <span class="code-keyword">try</span> {
            Writer writer = pageContext.getOut();
            template.merge(context, writer);
            writer.flush();
        } <span class="code-keyword">finally</span> {
            <span class="code-comment">// perform cleanup
</span>            jspFactory.releasePageContext(pageContext);
            actionContext.put(ServletActionContext.PAGE_CONTEXT, oldPageContext);
        }
    }

    <span class="code-keyword">private</span> <span class="code-object">String</span> getEncoding() {
        <span class="code-comment">// todo look into converting <span class="code-keyword">this</span> to using XWork/WebWork2 encoding rules
</span>        <span class="code-keyword">try</span> {
            <span class="code-keyword">return</span> Configuration.getString(<span class="code-quote">"webwork.i18n.encoding"</span>);
        } <span class="code-keyword">catch</span> (IllegalArgumentException e) {
            <span class="code-keyword">return</span> RuntimeSingleton.getString(RuntimeSingleton.OUTPUT_ENCODING, DEFAULT_OUTPUT_ENCODING);
        }
    }
    }</pre>
</div></div>

                    			    </td>
		    </tr>
	    </table>
    </body>
</html>
