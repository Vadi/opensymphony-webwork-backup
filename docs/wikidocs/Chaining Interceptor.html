<html>
    <head>
        <title>Chaining Interceptor</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">

				    <p class="paragraph"><h2 class="heading2"> How to use the Chaining Interceptor</h2></p>The following code snippet shows how interceptor stacks work for chaining.  If someone wants to post xwork.xml (and more complex) examples it would be appreciated <img src="./icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/>

<div class="code"><pre>Interceptors&#45;stack A before&#10;  Action A&#10;  Interceptor&#45;stack B before&#10;    Action B&#10;    Action B result&#10;  Interceptor&#45;stack B after&#10;Interceptor&#45;stack A after</pre></div>
<h2 class="heading2"> Interceptors that wrap Chained Actions</h2><p class="paragraph">Sometimes you may want to have an interceptor that wraps a number of chained actions (and is included in the Interceptor stack for each), but is only invoked at the start and end of the chain.  For example, an Interceptor that manages a Hibernate Session / Transaction.  Here is an example from my &#039;teach-myself-webwork-and-hibernate project named &#039;cash&#039; after Johnny Cash.</p><div class="code"><pre>&lt;interceptor name=&quot;hibernate&quot; class=&quot;cash.interceptor.HibernateInterceptor&quot;/&gt;&#10;      &lt;interceptor name=&quot;login&quot; class=&quot;cash.interceptor.LoginInterceptor&quot;/&gt;&#10;&#10;      &lt;interceptor&#45;stack name=&quot;cashDefaultStack&quot;&gt;&#10;        &lt;interceptor&#45;ref name=&quot;defaultStack&quot;/&gt;&#10;        &lt;interceptor&#45;ref name=&quot;component&quot;/&gt;&#10;        &lt;interceptor&#45;ref name=&quot;hibernate&quot;/&gt;&#10;        &lt;interceptor&#45;ref name=&quot;login&quot;/&gt;&#10;      &lt;/interceptor&#45;stack&gt;&#10;      &lt;interceptor&#45;stack name=&quot;cashValidationWorkflowStack&quot;&gt;&#10;        &lt;interceptor&#45;ref name=&quot;cashDefaultStack&quot;/&gt;&#10;        &lt;interceptor&#45;ref name=&quot;validation&quot;/&gt;&#10;        &lt;interceptor&#45;ref name=&quot;workflow&quot;/&gt;&#10;      &lt;/interceptor&#45;stack&gt;&#10;    &lt;/interceptors&gt;&#10;&#10;    &lt;<span class="java&#45;keyword">default</span>&#45;interceptor&#45;ref name=&quot;cashDefaultStack&quot;/&gt;&#10;&#10;    &lt;action name=&quot;list&quot; class=&quot;cash.action.SelectUserAction&quot;&gt;&#10;      &lt;result name=&quot;success&quot; type=&quot;dispatcher&quot;&gt;list.vm&lt;/result&gt;&#10;    &lt;/action&gt;&#10;&#10;    &lt;action name=&quot;edit&quot; class=&quot;cash.action.EditAction&quot;&gt;&#10;      &lt;result name=&quot;success&quot; type=&quot;chain&quot;&gt;list&lt;/result&gt;&#10;      &lt;result name=&quot;input&quot; type=&quot;dispatcher&quot;&gt;edit.vm&lt;/result&gt;&#10;      &lt;interceptor&#45;ref name=&quot;cashValidationWorkflowStack&quot;/&gt;&#10;    &lt;/action&gt;</pre></div><br/>
In this example, after editing a user, the EditAction is chained to the ListAction to display a list of all users to the screen.<p class="paragraph">We want the following
<div class="code"><pre>EditActionInterceptorStack &#45; before&#10;    EditAction&#10;    ListActionInterceptorStack (except <span class="java&#45;keyword">for</span> Hibernate) &#45; before&#10;      ListAction&#10;    ListActionInterceptorStack (except <span class="java&#45;keyword">for</span> Hibernate) &#45; end&#10;  EditActinInterceptorStack &#45; end</pre></div></p>But instead we get:
<div class="code"><pre>EditActionInterceptorStack &#45; before&#10;    EditAction&#10;    ListActionInterceptorStack (including Hibernate) &#45; before&#10;      ListAction&#10;    ListActionInterceptorStack (including Hibernate) &#45; end&#10;  EditActinInterceptorStack &#45; end  ERROR&#33;  Hibernate Session / Transaction is already closed&#33;&#33;&#33;</pre></div><br/>
The way to get the desired behaviour is to either not use a chained action (and incorporate the ListAction logic into EditAction, or to make the HibernateInterceptor smart enough to handle chained actions.<p class="paragraph">The HibernateInterceptor can use a ThreadLocal to hold state and detect if it is inside a chain.  When it detects this, it can do nothing.</p><div class="code"><pre><span class="java&#45;keyword">package</span> cash.interceptor;&#10;&#10;<span class="java&#45;keyword">import</span> net.sf.hibernate.HibernateException;&#10;<span class="java&#45;keyword">import</span> net.sf.hibernate.Transaction;&#10;&#10;<span class="java&#45;keyword">import</span> org.apache.log4j.Logger;&#10;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.xwork.Action;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.xwork.ActionInvocation;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.xwork.interceptor.Interceptor;&#10;&#10;<span class="java&#45;keyword">import</span> cash.action.HibernateAction;&#10;<span class="java&#45;keyword">import</span> cash.util.HibernateUtil;&#10;&#10;/&#42;&#42;&#10; &#42; &#64;author Gavin King&#10; &#42; &#64;author Joel Hockey&#10; &#42; &#64;version $Id&#58; $&#10; &#42;/&#10;<span class="java&#45;keyword">public</span> class HibernateInterceptor <span class="java&#45;keyword">implements</span> Interceptor &#123;&#10;    <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> Logger LOG = Logger.getLogger(HibernateInterceptor.class);&#10;&#10;    <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> ThreadLocal s&#95;threadLocal = <span class="java&#45;keyword">new</span> ThreadLocal();&#10;&#10;    /&#42;&#42; destroy &#42;/&#10;    <span class="java&#45;keyword">public</span> void destroy() &#123; &#125;&#10;&#10;    /&#42;&#42; init &#42;/&#10;    <span class="java&#45;keyword">public</span> void init() &#123; &#125;&#10;&#10;    /&#42;&#42; implement intercept &#42;/&#10;    <span class="java&#45;keyword">public</span> <span class="java&#45;object">String</span> intercept(ActionInvocation invocation) <span class="java&#45;keyword">throws</span> Exception &#123;&#10;        LOG.debug(&quot;HibernateInterceptor called&quot;);&#10;&#10;        Action action = invocation.getAction();&#10;        <span class="java&#45;keyword">if</span> (&#33;(action <span class="java&#45;keyword">instanceof</span> HibernateAction)) &#123; <span class="java&#45;keyword">return</span> invocation.invoke(); &#125;&#10;&#10;        // <span class="java&#45;keyword">continue</span> with HibernateAction&#10;        HibernateAction ha = (HibernateAction)action;&#10;&#10;        // <span class="java&#45;keyword">if</span> <span class="java&#45;keyword">this</span> interceptor is being chained, then transaction will already exist&#10;        // in that <span class="java&#45;keyword">case</span>, we should let the <span class="java&#45;keyword">outer</span> interceptor dispose of the sesion&#10;        <span class="java&#45;object">boolean</span> inChainedAction = <span class="java&#45;keyword">true</span>;&#10;        Transaction transaction = (Transaction)s&#95;threadLocal.get();&#10;        <span class="java&#45;keyword">if</span> (transaction == <span class="java&#45;keyword">null</span>) &#123;&#10;            inChainedAction = <span class="java&#45;keyword">false</span>;&#10;            transaction = HibernateUtil.currentSession().beginTransaction();&#10;            s&#95;threadLocal.set(transaction);&#10;        &#125;&#10;&#10;        <span class="java&#45;object">boolean</span> rollback = <span class="java&#45;keyword">false</span>;&#10;&#10;        <span class="java&#45;keyword">try</span> &#123;&#10;&#10;            <span class="java&#45;keyword">return</span> invocation.invoke();&#10;        &#125; <span class="java&#45;keyword">catch</span> (Exception e) &#123;&#10;            // Note that all the cleanup is done&#10;            // after the view is rendered, so we&#10;            // have an open session in the view&#10;&#10;            rollback = <span class="java&#45;keyword">true</span>;&#10;            <span class="java&#45;keyword">if</span> (e <span class="java&#45;keyword">instanceof</span> HibernateException) &#123;&#10;                LOG.error(&quot;HibernateException in execute()&quot;, e);&#10;                <span class="java&#45;keyword">return</span> HibernateAction.DBERROR;&#10;            &#125; <span class="java&#45;keyword">else</span> &#123;&#10;                LOG.error(&quot;Exception in execute()&quot;, e);&#10;                <span class="java&#45;keyword">throw</span> e;&#10;            &#125;&#10;        &#125; <span class="java&#45;keyword">finally</span> &#123;&#10;            <span class="java&#45;keyword">try</span> &#123;&#10;                <span class="java&#45;keyword">if</span> (&#33;inChainedAction) &#123;&#10;                    s&#95;threadLocal.set(<span class="java&#45;keyword">null</span>);&#10;                    disposeSession(transaction, ha.getRollback() || rollback);&#10;                &#125;&#10;            &#125; <span class="java&#45;keyword">catch</span> (HibernateException e) &#123;&#10;                LOG.error(&quot;HibernateException in dispose()&quot;, e);&#10;                <span class="java&#45;keyword">return</span> HibernateAction.DBERROR;&#10;            &#125;&#10;        &#125;&#10;    &#125;&#10;&#10;    /&#42;&#42; dispose of session &#42;/&#10;    <span class="java&#45;keyword">public</span> void disposeSession(Transaction transaction, <span class="java&#45;object">boolean</span> rollback) <span class="java&#45;keyword">throws</span> HibernateException &#123;&#10;        LOG.debug(&quot;disposing&quot;);&#10;&#10;        <span class="java&#45;keyword">if</span> (&#33;HibernateUtil.currentSession().isConnected()) &#123;&#10;            LOG.debug(&quot;Session has already been disposed of &#45; <span class="java&#45;keyword">this</span> will happen in a chained action&quot;);&#10;            <span class="java&#45;keyword">return</span>;&#10;        &#125;&#10;&#10;        <span class="java&#45;keyword">try</span> &#123;&#10;            <span class="java&#45;keyword">if</span> (transaction &#33;= <span class="java&#45;keyword">null</span>) &#123;&#10;                <span class="java&#45;keyword">if</span> (rollback) &#123;&#10;                    LOG.debug(&quot;rolling back&quot;);&#10;                    transaction.rollback();&#10;                &#125; <span class="java&#45;keyword">else</span> &#123;&#10;                    LOG.debug(&quot;committing&quot;);&#10;                    transaction.commit();&#10;                &#125;&#10;            &#125;&#10;        &#125; <span class="java&#45;keyword">catch</span> (HibernateException e) &#123;&#10;            LOG.error(&quot;error during commit/rollback&quot;, e);&#10;            <span class="java&#45;keyword">if</span> (&#33;rollback && transaction &#33;= <span class="java&#45;keyword">null</span>) &#123;&#10;                LOG.error(&quot;rolling back affter previous attempt to commit&quot;);&#10;                transaction.rollback();&#10;            &#125;&#10;            <span class="java&#45;keyword">throw</span> e;&#10;        &#125; <span class="java&#45;keyword">finally</span> &#123;&#10;            HibernateUtil.closeSession();&#10;        &#125;&#10;    &#125;&#10;&#125;</pre></div><p class="paragraph">For more information, also see <a href="http://wiki.opensymphony.com//display/OS/Webwork%2B-%2BWhy%2Bwould%2BI%2Buse%2BAction%2BChaining%253F">OS:Webwork - Why would I use Action Chaining?</a></p>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">Attachments:</a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="Chaining Interceptor_attachments/HibernateUtil.java">HibernateUtil.java</a> (application/octet-stream)
                                <br/>
                                                            <img src="icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="Chaining Interceptor_attachments/HibernateAction.java">HibernateAction.java</a> (application/octet-stream)
                                <br/>
                                                    </div>
				    
			    </td>
		    </tr>
	    </table>
    </body>
</html>
