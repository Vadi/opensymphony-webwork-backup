<html>
    <head>
        <title>WebWork - 
        Access to Webwork objects from JSP 2.0 EL
         </title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <p>To access Webwork ValueStack from third party JSP taglibs you have to expose property values to JSP.</p>

<p>You can use Webwork2 tag &lt;ww:set/&gt; to set named parameter in a JSP page, request, session or application scope. Following  example, sets a request scoped parameter 'a' to list of integers:</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;ww:set name=<span class="code-quote">"'a'"</span> value=<span class="code-quote">"{ 1, 2, 3, 4 }"</span> scope=<span class="code-quote">"request"</span>/&gt;</span></pre>
</div></div>

<p>After setting parameter, third party JSP taglibs can access variables, or you can use JSP 2.0 EL (Expression Language). This is convenient as short hand EL expression syntax <br/>
<tt>$<div class="error"><span class="error">Unknown macro: {expression}</span> </div></tt> can be used in a text or inside of tag attributes: </p>

<div class="code"><div class="codeContent">
<pre class="code-xml">a[0] = ${a[0]}

<span class="code-tag">&lt;sample:tag value=<span class="code-quote">"${a[1]}"</span>/&gt;</span></pre>
</div></div>

<p>In practice, you've got to expose a lot of different variables to make effective use of third party taglibs like displaytag or wurfl. This leads to a lot of <tt>&lt;ww:set/&gt;</tt> tags what made me investigate how to make access to ValueStack and OGNL more transparent.</p>

<table cellpadding='5' width='85%' cellspacing='8px' class='noteMacro' border="0" align='center'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b class="strong">Why can't we just replace EL with OGNL?</b><br />
<p>Unfortunately, it isn't that simple. I've tinkered with <tt>JSPFactory.setDefault()</tt> to wrap around <tt>getPageContext()</tt> and create <tt>ExpressionEvaluator</tt> that would use OGNL. </p>

<p>This works in practice, but code generated by Jasper2 doesn't call <tt>JSPFactory.getPageContext().getExpressionEvaluator()</tt> but goes directly to static method that is hardwired to jakarta commons-el implementation.</p>

<p>Even if it would work it wouldn't be <em>clean</em> as <tt>JSPFactory.setDefault()</tt> should only be called by JSP implementation.</p></td></tr></table>

<p>There is a simple, if not elegant, solution available in JSP 2.0 EL, for exposing ValueStack to OGNL. It is possible to create custom functions that can be called from EL expressions. Functions have to be 'public static' and specified in a TLD file. <br/>
Just import TLD in a JSP file where you've want to use a function. </p>

<p>For example, you could access action properties by evaluating OGNL expression by a function 'vs' (for valuestack) in EL:</p>

<div class="code"><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;%@ taglib uri=<span class="code-quote">"/WEB-INF/tld/wwel.tld"</span> prefix=<span class="code-quote">"x"</span> %&gt;</span>

a[0] = ${x:vs('a[0]')}
a[0] * 4 = ${x:vs('a[0] * 4')}

Current action name: ${x:name()}
Top of ValueStack: ${x:top()}</pre>
</div></div>

<p>To use this code you've got to add <tt>wwel.tld</tt> and <tt>Functions.java</tt> to your webapp project.</p>

<p>I would urge webworkers to define a set of functions that would be usable to wide community and include this in some future Webwork release.</p>

<div class="code"><div class="codeHeader"><b>wwel.tld</b></div><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;?xml version=<span class="code-quote">"1.0"</span>?&gt;</span>
&lt;taglib xmlns=<span class="code-quote">"http://java.sun.com/xml/ns/j2ee"</span>
	<span class="code-keyword">xmlns:xsi</span>=<span class="code-quote">"http://www.w3.org/2001/XMLSchema-instance"</span>
	xsi:schemaLocation=<span class="code-quote">"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-jsptaglibrary_2_0.xsd"</span>
	version=<span class="code-quote">"2.0"</span>&gt;

<span class="code-tag">&lt;description&gt;</span>
This taglib enables access to WebWork2 ValueStack 
from JSP 2.0 Expression Language
<span class="code-tag">&lt;/description&gt;</span>

<span class="code-tag">&lt;tlib-version&gt;</span>1.0<span class="code-tag">&lt;/tlib-version&gt;</span>

<span class="code-tag">&lt;short-name&gt;</span>wwel<span class="code-tag">&lt;/short-name&gt;</span>

<span class="code-tag">&lt;function&gt;</span>
	<span class="code-tag">&lt;name&gt;</span>vs<span class="code-tag">&lt;/name&gt;</span>
	<span class="code-tag">&lt;function-class&gt;</span>com.nmote.wwel.Functions<span class="code-tag">&lt;/function-class&gt;</span>
	<span class="code-tag">&lt;function-signature&gt;</span>
		java.lang.Object findOnValueStack(java.lang.String)
	<span class="code-tag">&lt;/function-signature&gt;</span>
<span class="code-tag">&lt;/function&gt;</span>

<span class="code-tag">&lt;function&gt;</span>
	<span class="code-tag">&lt;name&gt;</span>name<span class="code-tag">&lt;/name&gt;</span>
	<span class="code-tag">&lt;function-class&gt;</span>com.nmote.wwel.Functions<span class="code-tag">&lt;/function-class&gt;</span>
	<span class="code-tag">&lt;function-signature&gt;</span>
		java.lang.Object getActionName()
	<span class="code-tag">&lt;/function-signature&gt;</span>
<span class="code-tag">&lt;/function&gt;</span>

<span class="code-tag">&lt;function&gt;</span>
	<span class="code-tag">&lt;name&gt;</span>top<span class="code-tag">&lt;/name&gt;</span>
	<span class="code-tag">&lt;function-class&gt;</span>com.nmote.wwel.Functions<span class="code-tag">&lt;/function-class&gt;</span>
	<span class="code-tag">&lt;function-signature&gt;</span>
		java.lang.Object getTopOfValueStack()
	<span class="code-tag">&lt;/function-signature&gt;</span>
<span class="code-tag">&lt;/function&gt;</span>

<span class="code-tag">&lt;/taglib&gt;</span></pre>
</div></div>

<div class="code"><div class="codeHeader"><b>Functions.java</b></div><div class="codeContent">
<pre class="code-java"><span class="code-keyword">package</span> com.nmote.wwel;

<span class="code-keyword">import</span> com.opensymphony.xwork.ActionContext;

/**
 * Utility functions <span class="code-keyword">for</span> accessing webwork value stack and action context 
 * from JSP 2.0 EL taglibs.
 * 
 * @author Vjekoslav Nesek (vnesek@nmote.com)
 */
<span class="code-keyword">public</span> class Functions {

	<span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-object">Object</span> findOnValueStack(<span class="code-object">String</span> expr) {
		ActionContext a = ActionContext.getContext();
		<span class="code-object">Object</span> value = a.getValueStack().findValue(expr);
		<span class="code-keyword">return</span> value;
	}
	
	<span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-object">Object</span> getTopOfValueStack() {
		ActionContext a = ActionContext.getContext();
		<span class="code-object">Object</span> value = a.getValueStack().peek();
		<span class="code-keyword">return</span> value;
	}

	<span class="code-keyword">public</span> <span class="code-keyword">static</span> <span class="code-object">Object</span> getActionName() {
		ActionContext a = ActionContext.getContext();
		<span class="code-object">Object</span> value = a.getName();
		<span class="code-keyword">return</span> value;
	}	
}</pre>
</div></div>

                    			    </td>
		    </tr>
	    </table>
    </body>
</html>
