<html>
    <head>
        <title>WebWork 2 : File Upload Interceptor</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            WebWork 2 : File Upload Interceptor
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Nov 30, 2004 by <font color="#0050B2">jcarreira</font>.
				    </div>

				    <p class="paragraph">We can create a nice <b class="strong">reusable</b> Interceptor  which can hadle file uploads absolutely transparently and Action will not know anything about web-app and just gets its files:
<ol>
<li> <b class="strong">Before</b> further invocation it scans multipart request for files, and if content-type and size is acceptable it puts collected java.io.File instance to invocationContext.parameters Map named according to their &lt;input&gt; names.</li>
<li> In Action we can just declare properties of type File which will be set by parameters Inteceptor, in execute() we can move file with aFile.renameTo(...) to the right place, or just read the it and leave alone.</li>
<li> <b class="strong">After</b> invocation it removes all uploaded files via aFile.delete(). (Action should not care for iles uploaded waste disk space)</li>
</ol><br/>
This Interceptor may be configured to filter files with certain mime type or size, and of course to be applied to any action(s) or even included into stack.</p><div class="code"><div class="codeContent">
<pre>&lt;interceptor name=<span class="java&#45;quote">&quot;fileUpload&quot;</span> class=<span class="java&#45;quote">&quot;neuro.util.xwork.FileUploadInterceptor&quot;</span>&gt;&#10;    &lt;param name=<span class="java&#45;quote">&quot;allowedTypes&quot;</span>&gt;image/jpeg&lt;/param&gt;&#10;    &lt;param name=<span class="java&#45;quote">&quot;maximumSize&quot;</span>&gt;8192&lt;/param&gt;&#10;&lt;/interceptor&gt;</pre>
</div></div><p class="paragraph">This removes (duplicate) web-app specific code from Action and gives ua a nice reusable component that handles 90% of all typical file upload tasks. Neat. Also illustrates power of Interceptor concept of <a href="http://wiki.opensymphony.com//display/XW/XWork" title="XWork">XW:XWork</a>/<a href="WebWork.html" title="WebWork">WW:WebWork</a>. Try to do this in Struts. 8)</p>Things to improve: error handling, reporting &amp; i18n.<br/>

<div class="code"><div class="codeContent">
<pre><span class="java&#45;comment">//FileUploadInterceptor.java</span>&#10;&#10;<span class="java&#45;keyword">package</span> neuro.util.xwork;&#10;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.webwork.ServletActionContext;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.webwork.dispatcher.multipart.MultiPartRequestWrapper;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.xwork.ActionInvocation;&#10;<span class="java&#45;keyword">import</span> com.opensymphony.xwork.interceptor.Interceptor;&#10;<span class="java&#45;keyword">import</span> org.apache.commons.logging.Log;&#10;<span class="java&#45;keyword">import</span> org.apache.commons.logging.LogFactory;&#10;&#10;<span class="java&#45;keyword">import</span> java.io.File;&#10;<span class="java&#45;keyword">import</span> java.util.Collection;&#10;<span class="java&#45;keyword">import</span> java.util.Enumeration;&#10;<span class="java&#45;keyword">import</span> java.util.Iterator;&#10;&#10;/&#42;&#42;&#10; &#42;&#10; &#42;/&#10;<span class="java&#45;keyword">public</span> class FileUploadInterceptor <span class="java&#45;keyword">implements</span> Interceptor &#123;&#10;    <span class="java&#45;keyword">protected</span>&#160;<span class="java&#45;keyword">static</span>&#160;<span class="java&#45;keyword">final</span> Log log = LogFactory.getLog(FileUploadInterceptor.class);&#10;&#10;    <span class="java&#45;keyword">protected</span>&#160;<span class="java&#45;object">String</span> allowedTypes;&#10;    <span class="java&#45;keyword">protected</span>&#160;<span class="java&#45;object">String</span> disallowedTypes;&#10;    <span class="java&#45;keyword">protected</span>&#160;<span class="java&#45;object">Long</span> maximumSize;&#10;&#10;    /&#42;&#42;&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> FileUploadInterceptor() &#123;&#10;        <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;<span class="java&#45;keyword">new</span> FileUploadInterceptor()&quot;</span>);&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> void init() &#123;&#10;        <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;init()&quot;</span>);&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> void destroy() &#123;&#10;        <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;destroy()&quot;</span>);&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42; list of allowed mime&#45;types, optional&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> void setAllowedTypes(<span class="java&#45;object">String</span> allowedTypes) &#123;&#10;        <span class="java&#45;keyword">this</span>.allowedTypes = allowedTypes;&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42; list of diallowed mime&#45;types, optional&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> void setDisallowedTypes(<span class="java&#45;object">String</span> disallowedTypes) &#123;&#10;        <span class="java&#45;keyword">this</span>.disallowedTypes = disallowedTypes;&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42; maximum file Size, optional&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span> void setMaximumSize(<span class="java&#45;object">Long</span> maximumSize) &#123;&#10;        <span class="java&#45;keyword">this</span>.maximumSize = maximumSize;&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42;&#10;     &#42; TODO: i18n&#33;&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span>&#160;<span class="java&#45;object">String</span> intercept(ActionInvocation invocation) <span class="java&#45;keyword">throws</span> Exception &#123;&#10;        <span class="java&#45;keyword">if</span> (&#33;(ServletActionContext.getRequest() <span class="java&#45;keyword">instanceof</span> MultiPartRequestWrapper)) &#123;&#10;            <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;bypass &quot;</span> &#43; invocation.getProxy().getNamespace() &#43; <span class="java&#45;quote">&quot;/&quot;</span> &#43; invocation.getProxy().getActionName());&#10;            <span class="java&#45;keyword">return</span> invocation.invoke();&#10;        &#125;&#10;        MultiPartRequestWrapper multiWrapper = (MultiPartRequestWrapper) ServletActionContext.getRequest();&#10;        <span class="java&#45;keyword">if</span> (multiWrapper.hasErrors()) &#123;&#10;            Collection errors = multiWrapper.getErrors();&#10;            Iterator i = errors.iterator();&#10;            <span class="java&#45;keyword">while</span> (i.hasNext()) &#123;&#10;                <span class="java&#45;comment">//how to get to addError() from here&#63;</span>&#10;                log.error((<span class="java&#45;object">String</span>) i.next());&#10;            &#125;&#10;        &#125;&#10;&#10;        Enumeration e = multiWrapper.getFileNames();&#10;&#10;        <span class="java&#45;comment">//Bind allowed Files</span>&#10;        <span class="java&#45;keyword">while</span> (e.hasMoreElements()) &#123;&#10;            <span class="java&#45;comment">// get the value of <span class="java&#45;keyword">this</span> input tag</span>&#10;            <span class="java&#45;object">String</span> inputName = (<span class="java&#45;object">String</span>) e.nextElement();&#10;            <span class="java&#45;comment">// get the content type</span>&#10;            <span class="java&#45;object">String</span> contentType = multiWrapper.getContentType(inputName);&#10;            <span class="java&#45;comment">// get the name of the file from the input tag</span>&#10;            <span class="java&#45;object">String</span> fileName = multiWrapper.getFilesystemName(inputName);&#10;            <span class="java&#45;comment">// Get a File object <span class="java&#45;keyword">for</span> the uploaded File</span>&#10;            File file = multiWrapper.getFile(inputName);&#10;&#10;            log.info(<span class="java&#45;quote">&quot;file &quot;</span> &#43; inputName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; contentType &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; fileName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file);&#10;&#10;            <span class="java&#45;comment">// If it&#039;s <span class="java&#45;keyword">null</span> the upload failed</span>&#10;            <span class="java&#45;keyword">if</span> (file == <span class="java&#45;keyword">null</span>) &#123;&#10;                log.error(<span class="java&#45;quote">&quot;Error uploading: &quot;</span> &#43; fileName);&#10;            &#125; <span class="java&#45;keyword">else</span> &#123;&#10;                <span class="java&#45;keyword">if</span> (acceptFile(file, contentType, inputName))&#10;                    invocation.getInvocationContext().getParameters().put(inputName, file);&#10;                <span class="java&#45;comment">// Do additional processing/logging...</span>&#10;            &#125;&#10;        &#125;&#10;&#10;        <span class="java&#45;comment">//Invoke Action</span>&#10;        <span class="java&#45;object">String</span> result = invocation.invoke();&#10;&#10;        <span class="java&#45;comment">//Cleanup</span>&#10;        e = multiWrapper.getFileNames();&#10;        <span class="java&#45;keyword">while</span> (e.hasMoreElements()) &#123;&#10;            <span class="java&#45;object">String</span> inputValue = (<span class="java&#45;object">String</span>) e.nextElement();&#10;            File file = multiWrapper.getFile(inputValue);&#10;            log.info(<span class="java&#45;quote">&quot;removing file &quot;</span> &#43; inputValue &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file);&#10;            <span class="java&#45;keyword">if</span> (file &#33;= <span class="java&#45;keyword">null</span> &amp;&amp; file.isFile()) file.delete();&#10;        &#125;&#10;&#10;        <span class="java&#45;keyword">return</span> result;&#10;    &#125;&#10;&#10;    <span class="java&#45;comment">//overload <span class="java&#45;keyword">this</span> method to modify accept behaviour</span>&#10;    <span class="java&#45;comment">//TODO: addErrors&#63;</span>&#10;    <span class="java&#45;comment">//TODO: i18n&#33;</span>&#10;    <span class="java&#45;keyword">protected</span>&#160;<span class="java&#45;object">boolean</span> acceptFile(File file, <span class="java&#45;object">String</span> contentType, <span class="java&#45;object">String</span> inputName) &#123;&#10;        <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;checking&quot;</span> &#43; inputName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.getName() &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.length() &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; contentType);&#10;        <span class="java&#45;keyword">if</span> (maximumSize &#33;= <span class="java&#45;keyword">null</span> &amp;&amp; maximumSize.longValue() &lt; file.length())&#10;            log.error(<span class="java&#45;quote">&quot;file is too <span class="java&#45;object">long</span>:&quot;</span> &#43; inputName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.getName() &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.length());&#10;        <span class="java&#45;keyword">else</span>&#160;<span class="java&#45;keyword">if</span> (allowedTypes &#33;= <span class="java&#45;keyword">null</span> &amp;&amp; allowedTypes.indexOf(contentType) &lt; 0)&#10;            log.error(<span class="java&#45;quote">&quot;Content&#45;Type not allowed:&quot;</span> &#43; inputName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.getName() &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; contentType);&#10;        <span class="java&#45;keyword">else</span>&#160;<span class="java&#45;keyword">if</span> (disallowedTypes &#33;= <span class="java&#45;keyword">null</span> &amp;&amp; disallowedTypes.indexOf(contentType) &gt;= 0)&#10;            log.error(<span class="java&#45;quote">&quot;Content&#45;Type disallowed:&quot;</span> &#43; inputName &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; file.getName() &#43; <span class="java&#45;quote">&quot; &quot;</span> &#43; contentType);&#10;        <span class="java&#45;comment">//somehow we need to set error messages here...</span>&#10;        <span class="java&#45;keyword">else</span> &#123;&#10;            <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;accepted&quot;</span>);&#10;            <span class="java&#45;keyword">return</span>&#160;<span class="java&#45;keyword">true</span>;&#10;        &#125;&#10;        <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;not accepted&quot;</span>);&#10;        <span class="java&#45;keyword">return</span>&#160;<span class="java&#45;keyword">false</span>;&#10;    &#125;&#10;&#10;&#125;</pre>
</div></div><br/>
Example Page code:
<div class="code"><div class="codeContent">
<pre>&lt;form .... enctype=<span class="java&#45;quote">&quot;multipart/form&#45;data&quot;</span>&gt;&#10;    ....&#10;    select user icon:&#10;    &lt;input type=<span class="java&#45;quote">&quot;file&quot;</span> name=<span class="java&#45;quote">&quot;picture&quot;</span>&gt;&#10;&lt;form&gt;</pre>
</div></div><br/>
Example Action code:
<div class="code"><div class="codeContent">
<pre>/&#42;&#42;&#10;     &#42;/&#10;    <span class="java&#45;keyword">protected</span> File picture;&#10;&#10;    <span class="java&#45;keyword">public</span> void setPicture(File picture) &#123;&#10;        <span class="java&#45;keyword">this</span>.picture = picture;&#10;    &#125;&#10;&#10;    /&#42;&#42;&#10;     &#42;/&#10;    <span class="java&#45;keyword">public</span>&#160;<span class="java&#45;object">String</span> execute() &#123;&#10;        <span class="java&#45;keyword">if</span> (picture &#33;= <span class="java&#45;keyword">null</span> &amp;&amp; picture.isFile()) &#123;&#10;            <span class="java&#45;keyword">final</span> File target = <span class="java&#45;keyword">new</span> File(<span class="java&#45;quote">&quot;...&quot;</span>);&#10;            <span class="java&#45;keyword">if</span> (target.exists()) &#123;&#10;                <span class="java&#45;keyword">if</span> (log.isDebugEnabled()) log.debug(<span class="java&#45;quote">&quot;Removed previous picture version&quot;</span>);&#10;                target.delete();&#10;            &#125;&#10;            picture.renameTo(target);&#10;        &#125;&#10;    &#125;</pre>
</div></div><p class="paragraph"><em class="emphasis">If this Interceptor considered generally useful - may be it will be incorporated into WW2 codebase?</em></p>

				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="border/border_bottom.gif"><img src="border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Dec 14, 2004 16:36</font></td>
		    </tr>
	    </table>
    </body>
</html>